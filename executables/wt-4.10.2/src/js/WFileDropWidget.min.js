WT_DECLARE_WT_MEMBER(1,JavaScriptConstructor,"WFileDropWidget",(function(e,t,n){t.wtLObj=this;const i=this,o=e.WT;let s="Wt-dropzone-hover";const d="Wt-dropzone-indication",r="Wt-dropzone-dragstyle",l=[];let a=!1,c=!0,u=!1,f=!1,p=null,h=0,g=0;const m=document.createElement("input");m.type="file";m.setAttribute("multiple","multiple");m.style.display="none";t.appendChild(m);const v=document.createElement("div");v.classList.add("Wt-dropcover");document.body.appendChild(v);this.validFileCheck=function(e,t,n){const i=new FileReader;i.onload=function(){t(!0,n)};i.onerror=function(){t(!1,n)};i.readAsText(e.slice(0,32))};t.setAcceptDrops=function(e){c=e};t.setDropIndication=function(e){u=e};t.setDropForward=function(e){f=e};t.ondragenter=function(e){if(c){if(function(e){const t=e.dataTransfer?.items??null,n=null!==t&&Array.prototype.some.call(t,(e=>"file"===e.kind)),i=e.dataTransfer?.types??null,o=null!==i&&i.includes("Files");return n||o}(e)){0===g&&i.setPageHoverStyle();g=2;i.setWidgetHoverStyle(!0)}e.stopPropagation()}};t.ondragleave=function(e){const t=e.clientX,n=e.clientY;let o=document.elementFromPoint(t,n);0===t&&0===n&&(o=null);if(o!==v)i.resetDragDrop();else{i.setWidgetHoverStyle(!1);g=1}};t.ondragover=function(e){e.preventDefault()};const y=function(e){if((u||f)&&"none"!==o.css(t,"display")&&c){g=1;i.setPageHoverStyle()}};document.body.addEventListener("dragenter",y);v.ondragover=function(e){e.preventDefault();e.stopPropagation()};v.ondragleave=function(e){c&&1===g&&i.resetDragDrop()};v.ondrop=function(e){e.preventDefault();f?t.ondrop(e):i.resetDragDrop()};t.ondrop=function(e){e.preventDefault();if(c){i.resetDragDrop();0!==e.dataTransfer.files.length&&i.addFiles(e.dataTransfer.files)}};this.addFiles=function(n){const i=[];for(const e of n){const t=new Object;t.id=Math.floor(Math.random()*Math.pow(2,31));t.file=e;l.push(t);const n={};n.id=t.id;n.filename=t.file.name;n.type=t.file.type;n.size=t.file.size;i.push(n)}e.emit(t,"dropsignal",JSON.stringify(i))};t.addEventListener("click",(function(){if(c){m.value="";m.click()}}));t.markForSending=function(e){for(const t of e){const e=t.id;for(const t of l)if(t.id===e){t.ready=!0;break}}a||l[0].ready&&i.requestSend()};this.requestSend=function(){if(l[0].skip)i.uploadFinished(null);else{a=!0;e.emit(t,"requestsend",l[0].id)}};t.send=function(o,s){const d=l[0];if(d.file.size>n){e.emit(t,"filetoolarge",d.file.size);i.uploadFinished(null)}else{const e=null!==p&&s?i.workerSend:i.actualSend;i.validFileCheck(d.file,e,o)}};this.actualSend=function(e,t){if(!e){i.uploadFinished(null);return}const n=new XMLHttpRequest;n.addEventListener("load",i.uploadFinished);n.addEventListener("error",i.uploadFinished);n.addEventListener("abort",i.uploadFinished);n.addEventListener("timeout",i.uploadFinished);n.open("POST",t);l[0].request=n;const o=new FormData;o.append("file-id",l[0].id);o.append("data",l[0].file);n.send(o)};this.workerSend=function(e,t){if(e){p.upload=l[0];p.postMessage({cmd:"send",url:t,upload:l[0],chunksize:h})}else i.uploadFinished(null)};this.uploadFinished=function(n){(null!=n&&"load"===n.type&&200===n.currentTarget.status||!0===n)&&e.emit(t,"uploadfinished",l[0].id);l.splice(0,1);if(l[0]&&l[0].ready)i.requestSend();else{a=!1;e.emit(t,"donesending")}};t.cancelUpload=function(e){if(l[0]&&l[0].id===e){l[0].skip=!0;l[0].request?l[0].request.abort():p&&p.upload===l[0]&&p.postMessage({cmd:"cancel",upload:l[0]})}else for(let t=1;t<l.length;t++)l[t].id===e&&(l[t].skip=!0)};m.onchange=function(){c&&null!==this.files&&0!==this.files.length&&i.addFiles(this.files)};this.setPageHoverStyle=function(){if(u||f){v.classList.add(r);t.classList.add(r);u&&t.classList.add(d)}};this.setWidgetHoverStyle=function(e){t.classList.toggle(s,e)};this.resetDragDrop=function(){t.classList.remove(d);t.classList.remove(r);v.classList.remove(r);i.setWidgetHoverStyle(!1);g=0};t.configureHoverClass=function(e){s=e};t.setFilters=function(e){m.setAttribute("accept",e)};t.setUploadWorker=function(n){if(n&&window.Worker){p=new Worker(n);p.onmessage=function(n){if(n.data.workerfeatures){if("valid"!==n.data.workerfeatures){t.setUploadWorker(null);e.emit(t,"filternotsupported")}}else i.uploadFinished(n.data)};p.postMessage({cmd:"check"})}else p=null};t.setChunkSize=function(e){h=e};t.destructor=function(){document.body.removeEventListener("dragenter",y);document.body.removeChild(v)}}));